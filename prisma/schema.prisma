generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String            @id @default(uuid())
  email                 String?           @unique
  phone                 String?           @unique
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  name                  String?
  createdAnnouncements  Announcement[]
  consents              Consent[]
  deliveryAttempts      DeliveryAttempt[]
  createdEventReminders EventReminder[]
  createdEvents         Event[]
  acceptedInvitations   GroupInvitation[] @relation("InvitationsAccepted")
  sentInvitations       GroupInvitation[] @relation("InvitationsSent")
  memberships           Membership[]
  preferences           Preference[]

  @@map("users")
}

model FamilyGroup {
  id             String            @id @default(uuid())
  name           String
  slug           String            @unique
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  announcements  Announcement[]
  eventReminders EventReminder[]
  events         Event[]
  invitations    GroupInvitation[]
  memberships    Membership[]
  topics         Topic[]

  @@map("family_groups")
}

model Membership {
  id            String      @id @default(uuid())
  userId        String
  familyGroupId String
  role          Role        @default(MEMBER)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  familyGroup   FamilyGroup @relation(fields: [familyGroupId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, familyGroupId])
  @@map("memberships")
}

model Preference {
  id          String               @id @default(uuid())
  userId      String
  channel     CommunicationChannel
  enabled     Boolean              @default(false)
  destination String?
  verifiedAt  DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, channel])
  @@map("preferences")
}

model Announcement {
  id            String              @id @default(uuid())
  familyGroupId String
  title         String
  body          String
  type          AnnouncementType    @default(GENERAL)
  createdBy     String
  scheduledAt   DateTime?
  publishedAt   DateTime?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  topics        AnnouncementTopic[]
  creator       User                @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  familyGroup   FamilyGroup         @relation(fields: [familyGroupId], references: [id], onDelete: Cascade)

  @@index([familyGroupId, publishedAt])
  @@map("announcements")
}

model Event {
  id            String          @id @default(uuid())
  familyGroupId String
  title         String
  description   String?
  startsAt      DateTime
  endsAt        DateTime?
  location      String?
  createdBy     String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  fileUrl       String?
  imageUrl      String?
  reminders     EventReminder[]
  creator       User            @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  familyGroup   FamilyGroup     @relation(fields: [familyGroupId], references: [id], onDelete: Cascade)

  @@index([familyGroupId, startsAt])
  @@map("events")
}

model EventReminder {
  id            String      @id @default(uuid())
  eventId       String
  familyGroupId String
  message       String
  createdBy     String
  scheduledAt   DateTime?
  sentAt        DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  creator       User        @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  event         Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  familyGroup   FamilyGroup @relation(fields: [familyGroupId], references: [id], onDelete: Cascade)

  @@index([eventId, scheduledAt])
  @@index([familyGroupId, sentAt])
  @@map("event_reminders")
}

model DeliveryAttempt {
  id                String               @id @default(uuid())
  itemType          ItemType
  itemId            String
  userId            String
  channel           CommunicationChannel
  status            DeliveryStatus       @default(QUEUED)
  providerMessageId String?
  error             String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([itemType, itemId, status])
  @@index([userId, status])
  @@map("delivery_attempts")
}

model Topic {
  id            String              @id @default(uuid())
  familyGroupId String
  name          String
  slug          String
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  announcements AnnouncementTopic[]
  familyGroup   FamilyGroup         @relation(fields: [familyGroupId], references: [id], onDelete: Cascade)

  @@unique([familyGroupId, slug])
  @@map("topics")
}

model AnnouncementTopic {
  id             String       @id @default(uuid())
  announcementId String
  topicId        String
  createdAt      DateTime     @default(now())
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  topic          Topic        @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([announcementId, topicId])
  @@map("announcement_topics")
}

model Consent {
  id         String   @id @default(uuid())
  userId     String
  text       String
  version    String
  acceptedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, version])
  @@map("consents")
}

model GroupInvitation {
  id               String           @id @default(uuid())
  familyGroupId    String
  email            String
  token            String           @unique
  invitedBy        String
  acceptedByUserId String?
  status           InvitationStatus @default(PENDING)
  acceptedAt       DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  acceptedBy       User?            @relation("InvitationsAccepted", fields: [acceptedByUserId], references: [id])
  familyGroup      FamilyGroup      @relation(fields: [familyGroupId], references: [id], onDelete: Cascade)
  inviter          User             @relation("InvitationsSent", fields: [invitedBy], references: [id], onDelete: Cascade)

  @@unique([familyGroupId, email, status])
  @@index([token])
  @@index([email, status])
  @@map("group_invitations")
}

enum Role {
  ADMIN
  MEMBER
}

enum CommunicationChannel {
  EMAIL
  SMS
  WHATSAPP
  PUSH
}

enum AnnouncementType {
  SIMCHA
  GENERAL
}

enum ItemType {
  ANNOUNCEMENT
  EVENT
  EVENT_REMINDER
}

enum DeliveryStatus {
  QUEUED
  SENT
  FAILED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
}
